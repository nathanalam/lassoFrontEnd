<html>
    <head>
        <title>Lasso Miner</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
            crossorigin="anonymous"
        />
        <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script type=”text/javascript”
        src=”http://www.ncbi.nlm.nih.gov/projects/sviewer/js/sviewer.js”></script>
    </head>
    <body>
        <div id="lasso_container"></div>
        <script
            src="https://unpkg.com/react@17/umd/react.development.js"
            crossorigin
        ></script>
        <script
            src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"
            crossorigin
        ></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>

        <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-analytics.js"></script>

        <!-- Add Firebase products that you want to use -->
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-firestore.js"></script>
        <!-- Plotly JS-->
        <script
            crossorigin
            src="https://cdn.plot.ly/plotly-latest.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-plotly.js@1.0.2/dist/create-plotly-component.js"
        ></script>
        <!-- Main site logic -->
        <script type="text/babel">
            var firebaseConfig = {
                apiKey: "AIzaSyB5t_KPIagVnFh1kTeYOWmwOFtL2Gk1FyA",
                authDomain: "lasso-peptides.firebaseapp.com",
                databaseURL: "https://lasso-peptides.firebaseio.com",
                projectId: "lasso-peptides",
                storageBucket: "lasso-peptides.appspot.com",
                messagingSenderId: "175389116206",
                appId: "1:175389116206:web:038935cd7e647a30839cbf",
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            // Initialize Plotly
            const Plot = createPlotlyComponent(Plotly);

            const LassoTrack = (props) => {
                const lasso = props.lasso;

                let minRange = lasso.overallLength;
                let maxRange = 0;

                function updateRange(number) {
                    if (number < minRange) {
                        minRange = number;
                    }
                    if (number > maxRange) {
                        maxRange = number;
                    }
                }
                var sequence = {
                    x: [0, lasso.overallLength],
                    y: [1, 1],
                    type: "line",
                    name: "Sequence",
                    marker: {
                        color: "rgb(21,101,192)",
                    },
                    line: {
                        color: "rgb(21,101,192)",
                    },
                };

                var Aprot = {
                    x: [lasso.start, lasso.end],
                    y: [3, 3],
                    type: "line",
                    name: "A",
                    text: "A - precursor peptide",
                    marker: {
                        color: "rgb(46,125,50)",
                    },
                    line: {
                        color: "rgb(46,125,50)",
                    },
                };
                updateRange(lasso.start);
                updateRange(lasso.end);

                let closestOrfs = JSON.parse(lasso.closestOrfs);
                const replaceAll = (str, find, replace) =>
                    str.replace(new RegExp(find, "g"), replace);
                closestOrfs = JSON.parse(replaceAll(closestOrfs, "'", '"'));

                const protPlots = [];
                for (let j = 0; j < closestOrfs.length; j++) {
                    const closestI = closestOrfs[j];
                    const otherIprots = [];

                    // generate a random color
                    const red = 50 + Math.ceil(Math.random() * 150);
                    const green = 50 + Math.ceil(Math.random() * 150);
                    const blue = 50 + Math.ceil(Math.random() * 150);

                    // generate plot for this protein list
                    // for(var e = 0; e < closestIs.length; e++) {
                    const newProt = {
                        x: [closestI["start"], closestI["end"]],
                        y: [5 + 2 * j, 5 + 2 * j],
                        type: "line",
                        name:
                            closestI["motifType"] +
                            ": RF " +
                            closestI["readingFrame"],
                        text:
                            closestI["motifType"] +
                            "<br>RF " +
                            closestI["readingFrame"] +
                            "<br>Motif count: " +
                            closestI["count"],
                        marker: {
                            color:
                                "rgb(" + red + "," + green + "," + blue + ")",
                        },
                        line: {
                            color:
                                "rgb(" + red + "," + green + "," + blue + ")",
                        },
                    };
                    otherIprots.push(newProt);
                    updateRange(closestI["start"]);
                    updateRange(closestI["end"]);
                    protPlots.push(otherIprots);
                }

                var plotdata = [sequence, Aprot];
                for (var e = 0; e < protPlots.length; e++) {
                    protPlots[e].forEach((element) => plotdata.push(element));
                }

                return (
                    <Plot
                        data={plotdata}
                        layout={{
                            xaxis: {
                                range: [minRange - 20, maxRange + 20],
                            },
                            yaxis: {
                                range: [0, 10],
                            },
                            showlegend: false,
                        }}
                    />
                );
            };

            const LassoDropdown = (props) => {
                const lasso = props.lasso;
                return (
                    <div
                        className="card"
                        style={{ maxWidth: "80%", margin: "0 auto" }}
                    >
                        <div className="card-header">{lasso.sequence}</div>
                        <div className="card-body">
                            <a
                                href={
                                    "https://www.ncbi.nlm.nih.gov/nuccore/" +
                                    lasso.accession +
                                    "?report=genbank&from=" +
                                    lasso.start +
                                    "&to=" +
                                    lasso.end
                                }
                                className="card-title"
                            >
                                {lasso.accession} ({lasso.start}..{lasso.end})
                            </a>
                            <p className="card-text">
                                Rank: {lasso.rank}
                                <br />
                                Genome: {lasso.genome}
                                <br />
                                Index: {lasso.accession}
                                <br />
                                Range: {lasso.start}-{lasso.end}
                                <br />
                                Reading lasso: {lasso.orf}
                            </p>
                            <iframe
                                id="theiframe"
                                width="80%"
                                style={{ margin: "0 auto" }}
                                src={
                                    "https://www.ncbi.nlm.nih.gov/projects/sviewer/embedded_iframe.html?iframe=theiframe&embedded=true&id=" +
                                    lasso.accession +
                                    "&from=" +
                                    lasso.start +
                                    "&to=" +
                                    lasso.end
                                }
                                onLoad={() => {
                                    if (!window._SViFrame) {
                                        const _SViFrame = true;
                                        window.addEventListener(
                                            "message",
                                            function (e) {
                                                if (
                                                    e.origin ==
                                                        "https://www.ncbi.nlm.nih.gov" &&
                                                    !isNaN(e.data.h)
                                                )
                                                    document.getElementById(
                                                        e.data.f
                                                    ).height = parseInt(
                                                        e.data.h
                                                    );
                                            }
                                        );
                                    }
                                }}
                                height="291"
                            >
                                <p>Your browser does not support iframes.</p>
                            </iframe>
                            <br />
                            <br />
                            <LassoTrack lasso={lasso} />
                        </div>
                    </div>
                );
            };

            const CardHolder = (props) => {
                return props.cards.map((card, ind) => (
                    <LassoDropdown key={ind} lasso={card} />
                ));
            };

            const SearchBar = (props) => {
                return (
                    <div>
                        <div style={{ textAlign: "center" }}>
                            <button
                                style={{ margin: "0 auto" }}
                                className="btn btn-light"
                                type="button"
                                data-toggle="collapse"
                                data-target="#collapseExample"
                                aria-expanded="false"
                                aria-controls="collapseExample"
                            >
                                Search
                            </button>
                        </div>
                        <div className="collapse" id="collapseExample">
                            <div className="jumbotron">
                                <div className="input-group mb-3">
                                    <div className="input-group-prepend">
                                        <span
                                            className="input-group-text"
                                            id="basic-addon1"
                                        >
                                            Genome
                                        </span>
                                    </div>
                                    <input
                                        id="gen"
                                        list="genomes"
                                        name="genomes"
                                        type="text"
                                        className="form-control"
                                        placeholder="Genome Name"
                                        aria-label="Genome"
                                        aria-describedby="basic-addon1"
                                        value={props.genome}
                                        onChange={(newVal) =>
                                            props.onGenomeChange(
                                                newVal.target.value
                                            )
                                        }
                                    />
                                    <datalist id="genomes">
                                        {props.genomeList &&
                                        props.genomeList.length > 0 ? (
                                            props.genomeList.map(
                                                (genomeName, ind) => (
                                                    <option
                                                        key={ind}
                                                        value={genomeName}
                                                    />
                                                )
                                            )
                                        ) : (
                                            <option value="No genomes found" />
                                        )}
                                    </datalist>
                                </div>
                                <div className="input-group mb-3">
                                    <div className="input-group-prepend">
                                        <span
                                            className="input-group-text"
                                            id="basic-addon1"
                                        >
                                            Max Count
                                        </span>
                                    </div>
                                    <input
                                        id="num"
                                        name="num"
                                        type="text"
                                        className="form-control"
                                        placeholder="Max number of peptides"
                                        aria-label="Maxnum"
                                        aria-describedby="basic-addon1"
                                        value={props.maxNum}
                                        onChange={(newVal) =>
                                            props.onMaxNumChange(
                                                newVal.target.value
                                            )
                                        }
                                    />
                                </div>

                                <button
                                    type="button"
                                    className="btn btn-primary"
                                    id="submit"
                                    onClick={() => props.onSubmit()}
                                >
                                    Submit
                                </button>
                                <button
                                    type="button"
                                    className="btn btn-primary"
                                    data-toggle="collapse"
                                    data-target="#collapseExample"
                                    aria-expanded="false"
                                    aria-controls="collapseExample"
                                    id="close"
                                >
                                    ^
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            class LassoSearcher extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {
                        genome: "",
                        maxNum: 10,
                        genomeList: [],
                        cards: [],
                    };
                }

                componentDidMount() {
                    db.collection("genomes")
                        .get()
                        .then((querySnapshot) => {
                            querySnapshot.forEach((doc) => {
                                this.setState({
                                    genomeList: [
                                        ...this.state.genomeList,
                                        doc.id,
                                    ],
                                });
                            });
                        });
                }

                updateCards() {
                    const updateCardState = (val) => {
                        this.setState({
                            cards: val,
                        });
                    };
                    db.collection("peptides")
                        .where("genome", "==", this.state.genome)
                        .orderBy("rank", "desc")
                        .limit(this.state.maxNum)
                        .get()
                        .then(function (querySnapshot) {
                            const queries = [];
                            querySnapshot.forEach(function (doc) {
                                const data = doc.data();
                                queries.push(data);
                            });
                            updateCardState(queries);
                        });
                }

                render() {
                    return (
                        <div>
                            <SearchBar
                                genome={this.state.genome}
                                onGenomeChange={(newGenome) =>
                                    this.setState({
                                        genome: newGenome,
                                    })
                                }
                                genomeList={this.state.genomeList}
                                maxNum={this.state.maxNum}
                                onMaxNumChange={(newMaxNum) =>
                                    this.setState({
                                        maxNum: int(newMaxNum),
                                    })
                                }
                                onSubmit={() => this.updateCards()}
                            />
                            <CardHolder cards={this.state.cards} />
                        </div>
                    );
                }
            }

            // publish the root react container
            const e = React.createElement;
            const domContainer = document.querySelector("#lasso_container");
            ReactDOM.render(e(LassoSearcher), domContainer);
        </script>
    </body>
</html>
