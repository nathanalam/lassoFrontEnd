<html>
    <head>
        <title>Lasso Miner</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
            crossorigin="anonymous"
        />
        <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script type=”text/javascript”
        src=”http://www.ncbi.nlm.nih.gov/projects/sviewer/js/sviewer.js”></script>
    </head>
    <body>
        <div id="lasso_container"></div>
        <script
            src="https://unpkg.com/react@17/umd/react.development.js"
            crossorigin
        ></script>
        <script
            src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"
            crossorigin
        ></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>

        <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-analytics.js"></script>

        <!-- Add Firebase products that you want to use -->
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-firestore.js"></script>
        <!-- d3.js-->
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <!-- Main site logic -->
        <script type="text/babel">
            var firebaseConfig = {
                apiKey: "AIzaSyB5t_KPIagVnFh1kTeYOWmwOFtL2Gk1FyA",
                authDomain: "lasso-peptides.firebaseapp.com",
                databaseURL: "https://lasso-peptides.firebaseio.com",
                projectId: "lasso-peptides",
                storageBucket: "lasso-peptides.appspot.com",
                messagingSenderId: "175389116206",
                appId: "1:175389116206:web:038935cd7e647a30839cbf",
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // helper functions
            const lassoEquality = (l1, l2) =>
                l1.sequence === l2.sequence &&
                l1.genome === l2.genome &&
                l1.start === l2.start &&
                l1.end === l2.end;

            const PrecursorDetails = (props) => {
                const lasso = props.lasso;
                function sequenceToVisual(sequence) {
                    const combinations = [];

                    const regex = /T[A-Z]{7,9}[DE]/gm;
                    let m;

                    while ((m = regex.exec(sequence)) !== null) {
                        // This is necessary to avoid infinite loops with zero-width matches
                        if (m.index === regex.lastIndex) {
                            regex.lastIndex++;
                        }

                        // The result can be accessed through the `m`-variable.
                        m.forEach((match, groupIndex) => {
                            combinations.push({
                                leader: sequence.substring(
                                    0,
                                    sequence.indexOf(match) + 2
                                ),
                                core: match.substring(2),
                                tail: sequence.substring(
                                    sequence.indexOf(match) + match.length
                                ),
                            });
                        });
                    }
                    return combinations;
                }
                return (
                    <div>
                        <a
                            href={
                                "https://www.ncbi.nlm.nih.gov/nuccore/" +
                                lasso.accession +
                                "?report=genbank&from=" +
                                lasso.start +
                                "&to=" +
                                lasso.end
                            }
                            className="card-title"
                        >
                            {lasso.accession} ({lasso.start}..{lasso.end})
                        </a>
                        <br />
                        {sequenceToVisual(lasso.sequence).map(
                            (combination, ind) => (
                                <p key={ind}>
                                    <span style={{ color: "red" }}>
                                        {combination.leader}
                                    </span>
                                    <span style={{ color: "green" }}>
                                        {combination.core}
                                    </span>
                                    <span style={{ color: "blue" }}>
                                        {combination.tail}
                                    </span>
                                </p>
                            )
                        )}
                        Rank: {lasso.rank}
                        <br />
                        Secondary Rank: {lasso.secondaryRank}
                        <br />
                        Genome: {lasso.genome}
                        <br />
                        Range: {lasso.start}-{lasso.end}
                    </div>
                );
            };

            const AccessoryDetails = (props) => {
                const accessory = props.accessory;
                return <div></div>;
            };

            const Modal = (props) => {
                return (
                    <div
                        className="modal fade"
                        id="exampleModal"
                        tabIndex="-1"
                        role="dialog"
                        aria-labelledby="exampleModalLabel"
                        aria-hidden="true"
                    >
                        <div className="modal-dialog modal-lg" role="document">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5
                                        className="modal-title"
                                        id="exampleModalLabel"
                                    >
                                        {props.title}
                                    </h5>
                                    <button
                                        type="button"
                                        className="close"
                                        data-dismiss="modal"
                                        aria-label="Close"
                                    >
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div className="modal-body">{props.body}</div>
                                <div className="modal-footer">
                                    <button
                                        type="button"
                                        className="btn btn-secondary"
                                        data-dismiss="modal"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const LassoTrack = (props) => {
                const lasso = props.lasso;

                let minRange = lasso.overallLength;
                let maxRange = 0;

                function updateRange(number) {
                    if (number < minRange) {
                        minRange = number;
                    }
                    if (number > maxRange) {
                        maxRange = number;
                    }
                }

                updateRange(lasso.start);
                updateRange(lasso.end);

                let closestOrfs = JSON.parse(lasso.closestOrfs);
                const replaceAll = (str, find, replace) =>
                    str.replace(new RegExp(find, "g"), replace);
                closestOrfs = JSON.parse(replaceAll(closestOrfs, "'", '"'));

                const protPlots = [];
                for (let j = 0; j < closestOrfs.length; j++) {
                    const closestI = closestOrfs[j];
                    const otherIprots = [];

                    // generate a random color
                    const red = 50 + Math.ceil(Math.random() * 150);
                    const green = 50 + Math.ceil(Math.random() * 150);
                    const blue = 50 + Math.ceil(Math.random() * 150);

                    // generate plot for this protein list
                    // for(var e = 0; e < closestIs.length; e++) {
                    const newProt = {
                        x: [closestI["start"], closestI["end"]],
                        y: [5 + 2 * j, 5 + 2 * j],
                        type: "line",
                        name:
                            closestI["motifType"] +
                            ": RF " +
                            closestI["readingFrame"],
                        text:
                            closestI["motifType"] +
                            "<br>RF " +
                            closestI["readingFrame"] +
                            "<br>Motif count: " +
                            closestI["count"],
                        marker: {
                            color:
                                "rgb(" + red + "," + green + "," + blue + ")",
                        },
                        line: {
                            color:
                                "rgb(" + red + "," + green + "," + blue + ")",
                        },
                    };
                    otherIprots.push(newProt);
                    updateRange(closestI["start"]);
                    updateRange(closestI["end"]);
                    protPlots.push(otherIprots);
                }

                const d3Container = React.useRef(null);
                const width = 800;
                const height = 300;

                const normalize = (xpoint) =>
                    50 +
                    (width - 50) *
                        ((xpoint - minRange) / (maxRange - minRange));
                const motifColors = ["green", "blue", "yellow", "orange"];
                const readingFrameToHeight = (rf) =>
                    [0, 0, 100, 200][Math.abs(rf)];
                React.useEffect(() => {
                    if (d3Container.current) {
                        const svg = d3.select(d3Container.current);
                        svg.selectAll("*").remove();
                        const appendRFlabel = (label) => {
                            svg.append("text")
                                .attr("x", 0)
                                .attr("y", readingFrameToHeight(label) + 20)
                                .attr("dy", ".35em")
                                .text(label.toString());
                        };
                        appendRFlabel(1);
                        appendRFlabel(2);
                        appendRFlabel(3);

                        const chevron = (x, y, width, height, direction) => {
                            const offset = width > 20 ? 20 : width * 0.8;
                            if (direction > 0)
                                return `${x},${y} ${x + width - offset},${y} ${
                                    x + width
                                },${y + height / 2} ${x + width - offset},${
                                    y + height
                                } ${x},${y + height}`;
                            return `${x + offset},${y} ${x + width},${y} ${
                                x + width
                            },${y + height} ${x + offset},${y + height} ${x},${
                                y + height / 2
                            }`;
                        };

                        svg.append("polygon")
                            .attr(
                                "points",
                                chevron(
                                    normalize(lasso.start),
                                    readingFrameToHeight(lasso.orf),
                                    normalize(lasso.end) -
                                        normalize(lasso.start),
                                    40,
                                    lasso.orf
                                )
                            )
                            .attr("stroke", "black")
                            .attr("fill", "red")
                            .on("click", function () {
                                props.updateModal({
                                    title: "Precursor Details",
                                    body: (
                                        <div>
                                            <PrecursorDetails lasso={lasso} />
                                            <NCBIFrame
                                                start={lasso.start}
                                                end={lasso.end}
                                                accession={lasso.accession}
                                            />
                                        </div>
                                    ),
                                });
                            })
                            .attr("data-toggle", "modal")
                            .attr("data-target", "#exampleModal")
                            .style("cursor", "pointer")
                            .append("title")
                            .text(`Precursor A`);

                        for (let j = 0; j < closestOrfs.length; j++) {
                            const closestI = closestOrfs[j];
                            svg.append("polygon")
                                .attr(
                                    "points",
                                    chevron(
                                        normalize(closestI.start),
                                        readingFrameToHeight(
                                            closestI.readingFrame
                                        ),
                                        normalize(closestI.end) -
                                            normalize(closestI.start),
                                        40,
                                        closestI.readingFrame
                                    )
                                )
                                .attr("stroke", "black")
                                .attr(
                                    "fill",
                                    motifColors[j % motifColors.length]
                                )
                                .on("click", function () {
                                    props.updateModal({
                                        title: "Accessory Protein Details",
                                        body: (
                                            <div>
                                                <AccessoryDetails
                                                    accessory={closestI}
                                                />
                                                <NCBIFrame
                                                    start={closestI.start}
                                                    end={closestI.end}
                                                    accession={lasso.accession}
                                                />
                                            </div>
                                        ),
                                    });
                                })
                                .attr("data-toggle", "modal")
                                .attr("data-target", "#exampleModal")
                                .style("cursor", "pointer")
                                .append("title")
                                .text(closestI.motifType);
                        }
                    }
                }, [d3Container.current, lasso]);

                return (
                    <svg
                        className="d3-component"
                        width={width}
                        height={height}
                        ref={d3Container}
                    />
                );
            };

            const NCBIFrame = (props) => {
                return (
                    <iframe
                        id="theiframe"
                        width="80%"
                        style={{ margin: "0 auto" }}
                        src={
                            "https://www.ncbi.nlm.nih.gov/projects/sviewer/embedded_iframe.html?iframe=theiframe&embedded=true&id=" +
                            props.accession +
                            "&from=" +
                            props.start +
                            "&to=" +
                            props.end
                        }
                        onLoad={() => {
                            if (!window._SViFrame) {
                                const _SViFrame = true;
                                window.addEventListener(
                                    "message",
                                    function (e) {
                                        if (
                                            e.origin ==
                                                "https://www.ncbi.nlm.nih.gov" &&
                                            !isNaN(e.data.h)
                                        )
                                            document.getElementById(
                                                e.data.f
                                            ).height = parseInt(e.data.h);
                                    }
                                );
                            }
                        }}
                        height="291"
                    >
                        <p>Your browser does not support iframes.</p>
                    </iframe>
                );
            };

            const LassoDropdown = (props) => {
                const lasso = props.lasso;
                lasso.name =
                    lasso.genome.substring(0, 3).toUpperCase() +
                    lasso.accession
                        .substring(
                            lasso.accession.length - 3,
                            lasso.accession.length
                        )
                        .toUpperCase() +
                    lasso.sequence.substring(0, 3);
                const [collapsed, setCollapsed] = React.useState(true);
                return (
                    <div
                        className="card"
                        style={{ maxWidth: "80%", margin: "4em auto" }}
                    >
                        <div
                            onClick={() => setCollapsed(!collapsed)}
                            className="card-header"
                            style={{ cursor: "pointer" }}
                        >
                            {lasso.name}
                        </div>
                        <div
                            className={
                                "card-body collapse" +
                                (collapsed ? "" : ".show")
                            }
                        >
                            {props.isFavorite ? (
                                <button
                                    onClick={() =>
                                        props.unfavorite(props.lasso)
                                    }
                                >
                                    Unfavorite
                                </button>
                            ) : (
                                <button
                                    onClick={() => props.favorite(props.lasso)}
                                >
                                    Favorite
                                </button>
                            )}

                            <br />
                            <h3 className="card-text">{lasso.sequence}</h3>
                            <br />
                            <br />
                            <LassoTrack
                                lasso={lasso}
                                updateModal={props.updateModal}
                            />
                        </div>
                    </div>
                );
            };

            const CardHolder = (props) => {
                return props.lassos.map((lasso, ind) => {
                    let isFavorite = false;
                    props.favorites.forEach((favorite) => {
                        if (lassoEquality(lasso, favorite)) isFavorite = true;
                    });
                    return (
                        <LassoDropdown
                            key={ind}
                            lasso={lasso}
                            favorite={props.favoriteLasso}
                            unfavorite={props.unfavoriteLasso}
                            isFavorite={isFavorite}
                            updateModal={props.updateModal}
                        />
                    );
                });
            };

            const SearchBar = (props) => {
                return (
                    <div>
                        <div className="jumbotron">
                            <div className="input-group mb-3">
                                <div className="input-group-prepend">
                                    <span
                                        className="input-group-text"
                                        id="basic-addon1"
                                    >
                                        Genome
                                    </span>
                                </div>
                                <input
                                    id="gen"
                                    list="genomes"
                                    name="genomes"
                                    type="text"
                                    className="form-control"
                                    placeholder="Genome Name"
                                    aria-label="Genome"
                                    aria-describedby="basic-addon1"
                                    value={props.genome}
                                    onChange={(newVal) =>
                                        props.onGenomeChange(
                                            newVal.target.value
                                        )
                                    }
                                />
                                <datalist id="genomes">
                                    {props.genomeList &&
                                    props.genomeList.length > 0 ? (
                                        props.genomeList.map(
                                            (genomeName, ind) => (
                                                <option
                                                    key={ind}
                                                    value={genomeName}
                                                />
                                            )
                                        )
                                    ) : (
                                        <option value="No genomes found" />
                                    )}
                                </datalist>
                            </div>
                            <div className="input-group mb-3">
                                <div className="input-group-prepend">
                                    <span
                                        className="input-group-text"
                                        id="basic-addon1"
                                    >
                                        Max Count
                                    </span>
                                </div>
                                <input
                                    id="num"
                                    name="num"
                                    type="text"
                                    className="form-control"
                                    placeholder="Max number of peptides"
                                    aria-label="Maxnum"
                                    aria-describedby="basic-addon1"
                                    value={props.maxNum}
                                    onChange={(newVal) =>
                                        props.onMaxNumChange(
                                            newVal.target.value
                                        )
                                    }
                                />
                            </div>

                            <button
                                type="button"
                                className="btn btn-primary"
                                id="submit"
                                onClick={() => props.onSubmit()}
                            >
                                Submit
                            </button>
                        </div>
                    </div>
                );
            };

            class LassoSearcher extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {
                        genome: "",
                        maxNum: 10,
                        genomeList: [],
                        lassos: [],
                        tabSelection: 0,
                        favorites: [],
                        modalContent: {
                            title: "Details",
                            body: "...",
                        },
                    };
                }

                componentDidMount() {
                    db.collection("genomes")
                        .get()
                        .then((querySnapshot) => {
                            querySnapshot.forEach((doc) => {
                                this.setState({
                                    genomeList: [
                                        ...this.state.genomeList,
                                        doc.id,
                                    ],
                                });
                            });
                        });
                    this.setState({
                        favorites: JSON.parse(
                            window.localStorage.getItem("favorites")
                        ),
                    });
                }

                updateLassos() {
                    const updateLassoState = (val) => {
                        this.setState({
                            lassos: val,
                        });
                    };
                    db.collection("peptides")
                        .where("genome", "==", this.state.genome)
                        .orderBy("secondaryRank", "desc")
                        .limit(this.state.maxNum)
                        .get()
                        .then(function (querySnapshot) {
                            const queries = [];
                            querySnapshot.forEach(function (doc) {
                                const data = doc.data();
                                queries.push(data);
                            });
                            updateLassoState(queries);
                        });
                }

                favoriteLassos(newFavorites) {
                    const updateFavoriteState = (val) => {
                        this.setState({
                            favorites: newFavorites,
                        });
                    };
                    updateFavoriteState(newFavorites);
                    window.localStorage.setItem(
                        "favorites",
                        JSON.stringify(newFavorites)
                    );
                }

                exportToCsv() {
                    let csvContent =
                        "data:text/csv;charset=utf-8," +
                        Object.keys(this.state.favorites[0]).join(",") +
                        "\n" +
                        this.state.favorites
                            .map((e) => Object.values(e).join(","))
                            .join("\n");
                    const encodedUri = encodeURI(csvContent);
                    window.open(encodedUri);
                }

                render() {
                    return (
                        <div>
                            <Modal
                                title={this.state.modalContent.title}
                                body={this.state.modalContent.body}
                            />
                            <ul className="nav nav-tabs">
                                <li className="nav-item">
                                    <a
                                        className={
                                            "nav-link" +
                                            (this.state.tabSelection == 0
                                                ? " active"
                                                : "")
                                        }
                                        aria-current="page"
                                        href="#"
                                        onClick={() =>
                                            this.setState({ tabSelection: 0 })
                                        }
                                    >
                                        Search
                                    </a>
                                </li>
                                <li className="nav-item">
                                    <a
                                        className={
                                            "nav-link" +
                                            (this.state.tabSelection == 1
                                                ? " active"
                                                : "")
                                        }
                                        href="#"
                                        onClick={() =>
                                            this.setState({ tabSelection: 1 })
                                        }
                                    >
                                        Favorites
                                    </a>
                                </li>
                            </ul>
                            {
                                {
                                    0: (
                                        <div>
                                            <SearchBar
                                                genome={this.state.genome}
                                                onGenomeChange={(newGenome) =>
                                                    this.setState({
                                                        genome: newGenome,
                                                    })
                                                }
                                                genomeList={
                                                    this.state.genomeList
                                                }
                                                maxNum={this.state.maxNum}
                                                onMaxNumChange={(newMaxNum) =>
                                                    this.setState({
                                                        maxNum: int(newMaxNum),
                                                    })
                                                }
                                                onSubmit={() =>
                                                    this.updateLassos()
                                                }
                                            />
                                            <CardHolder
                                                lassos={this.state.lassos}
                                                favoriteLasso={(newLasso) =>
                                                    this.favoriteLassos([
                                                        ...this.state.favorites,
                                                        newLasso,
                                                    ])
                                                }
                                                favorites={this.state.favorites}
                                                unfavoriteLasso={(oldLasso) => {
                                                    const oldFavorites = this
                                                        .state.favorites;
                                                    let removeInd = -1;
                                                    for (
                                                        let i = 0;
                                                        i < oldFavorites.length;
                                                        i++
                                                    ) {
                                                        if (
                                                            lassoEquality(
                                                                oldLasso,
                                                                oldFavorites[i]
                                                            )
                                                        )
                                                            removeInd = i;
                                                    }
                                                    const newFavorites = [
                                                        ...oldFavorites.slice(
                                                            0,
                                                            removeInd
                                                        ),
                                                        ...oldFavorites.slice(
                                                            removeInd + 1,
                                                            oldFavorites.length
                                                        ),
                                                    ];
                                                    this.favoriteLassos(
                                                        newFavorites
                                                    );
                                                }}
                                                updateModal={(newContent) => {
                                                    this.setState({
                                                        modalContent: {
                                                            title:
                                                                newContent.title,
                                                            body:
                                                                newContent.body,
                                                        },
                                                    });
                                                }}
                                            />
                                        </div>
                                    ),
                                    1: (
                                        <div>
                                            <button
                                                onClick={() =>
                                                    this.exportToCsv()
                                                }
                                            >
                                                Export to CSV
                                            </button>
                                            <br />
                                            <CardHolder
                                                lassos={this.state.favorites}
                                                favorites={this.state.favorites}
                                                unfavoriteLasso={(oldLasso) => {
                                                    const oldFavorites = this
                                                        .state.favorites;
                                                    let removeInd = -1;
                                                    for (
                                                        let i = 0;
                                                        i < oldFavorites.length;
                                                        i++
                                                    ) {
                                                        if (
                                                            lassoEquality(
                                                                oldLasso,
                                                                oldFavorites[i]
                                                            )
                                                        )
                                                            removeInd = i;
                                                    }
                                                    const newFavorites = [
                                                        ...oldFavorites.slice(
                                                            0,
                                                            removeInd
                                                        ),
                                                        ...oldFavorites.slice(
                                                            removeInd + 1,
                                                            oldFavorites.length
                                                        ),
                                                    ];
                                                    this.favoriteLassos(
                                                        newFavorites
                                                    );
                                                }}
                                                updateModal={(newContent) => {
                                                    this.setState({
                                                        modalContent: {
                                                            title:
                                                                newContent.title,
                                                            body:
                                                                newContent.body,
                                                        },
                                                    });
                                                }}
                                            />
                                        </div>
                                    ),
                                }[this.state.tabSelection]
                            }
                        </div>
                    );
                }
            }

            // publish the root react container
            const e = React.createElement;
            const domContainer = document.querySelector("#lasso_container");
            ReactDOM.render(e(LassoSearcher), domContainer);
        </script>
    </body>
</html>
